<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SwiftClear â€” Real-Time TSA Wait Times</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #080C14;
      --bg-card:   rgba(14, 20, 34, 0.75);
      --border:    rgba(255, 255, 255, 0.10);
      --text:      #F0F4FF;
      --muted:     rgba(180, 195, 230, 0.55);
      --accent:    #3B82F6;
      --safe:      #22D3EE;
      --soon:      #FBBF24;
      --urgent:    #F97316;
      --critical:  #EF4444;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 60% 40% at 20% 20%, rgba(59,130,246,0.12) 0%, transparent 70%),
        radial-gradient(ellipse 50% 50% at 80% 80%, rgba(34,211,238,0.08) 0%, transparent 70%);
      pointer-events: none;
    }

    .container { max-width: 960px; margin: 0 auto; padding: 0 24px; }

    /* â”€â”€ Nav â”€â”€ */
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 0;
    }
    .wordmark {
      font-family: 'Courier New', monospace;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--text);
    }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .last-updated {
      font-size: 12px;
      color: var(--muted);
    }
    .refresh-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 7px 14px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }
    .refresh-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.25); }

    /* â”€â”€ Hero â”€â”€ */
    .hero {
      text-align: center;
      padding: 72px 0 56px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(59,130,246,0.12);
      border: 1px solid rgba(59,130,246,0.30);
      border-radius: 999px;
      padding: 5px 14px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1.5px;
      color: var(--accent);
      text-transform: uppercase;
      margin-bottom: 28px;
    }
    .badge-dot {
      width: 6px; height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    h1 {
      font-size: clamp(36px, 7vw, 68px);
      font-weight: 800;
      line-height: 1.05;
      letter-spacing: -2px;
      margin-bottom: 20px;
    }
    h1 span { color: var(--accent); }
    .hero-sub {
      font-size: clamp(16px, 2.5vw, 19px);
      color: var(--muted);
      max-width: 500px;
      margin: 0 auto 40px;
      line-height: 1.6;
    }
    .cta-row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
      transition: opacity 0.2s, transform 0.15s;
      cursor: pointer;
      border: none;
    }
    .btn:hover { opacity: 0.88; transform: translateY(-1px); }
    .btn-primary {
      background: linear-gradient(135deg, #1D4ED8, #3B82F6);
      color: #fff;
    }

    /* â”€â”€ Glass card â”€â”€ */
    .glass {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 24px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      overflow: hidden;
    }

    /* â”€â”€ Airport selector â”€â”€ */
    .airport-selector-section { margin-bottom: 32px; }
    .airport-selector-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .airport-selector-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    select {
      appearance: none;
      -webkit-appearance: none;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      font-weight: 600;
      padding: 12px 44px 12px 16px;
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23607090' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      min-width: 260px;
      transition: border-color 0.2s;
    }
    select:focus {
      outline: none;
      border-color: rgba(59,130,246,0.5);
    }
    select option { background: #0E1422; color: var(--text); }

    /* â”€â”€ Live wait times â”€â”€ */
    .live-section { margin-bottom: 48px; }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .section-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 2.5px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .live-dot {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--safe);
      font-weight: 600;
    }
    .live-dot::before {
      content: '';
      display: block;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--safe);
      animation: pulse 2s ease-in-out infinite;
    }

    .terminals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }
    .terminal-card {
      padding: 20px 22px;
      border-radius: 18px;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.15s;
      position: relative;
    }
    .terminal-card:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.2); }
    .terminal-card.selected { border-color: rgba(59,130,246,0.5); background: rgba(59,130,246,0.06); }
    .terminal-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .terminal-name {
      font-size: 14px;
      font-weight: 700;
      line-height: 1.3;
    }
    .precheck-tag {
      font-size: 10px;
      font-weight: 700;
      color: var(--safe);
      background: rgba(34,211,238,0.12);
      border: 1px solid rgba(34,211,238,0.30);
      border-radius: 6px;
      padding: 3px 7px;
      white-space: nowrap;
      margin-top: 1px;
    }
    .wait-display {
      display: flex;
      align-items: baseline;
      gap: 5px;
    }
    .wait-number {
      font-family: 'Courier New', monospace;
      font-size: 36px;
      font-weight: 700;
      line-height: 1;
    }
    .wait-unit {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .wait-sublabel {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .color-safe     { color: var(--safe); }
    .color-soon     { color: var(--soon); }
    .color-urgent   { color: var(--urgent); }
    .color-critical { color: var(--critical); }

    /* skeleton / loading */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .skeleton-number { height: 36px; width: 60px; }
    .skeleton-text   { height: 14px; width: 140px; }
    .skeleton-text-sm { height: 12px; width: 90px; margin-top: 6px; }

    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 48px 24px;
      color: var(--muted);
      font-size: 15px;
    }
    .error-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 32px 24px;
      color: var(--urgent);
      font-size: 14px;
    }

    /* â”€â”€ Leave-by calculator â”€â”€ */
    .calculator-section { margin-bottom: 64px; }
    .calculator-card { padding: 28px 32px; }
    .calculator-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .calculator-sub {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 24px;
      line-height: 1.5;
    }
    .calc-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .field-group { display: flex; flex-direction: column; gap: 6px; }
    .field-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--muted);
    }
    input[type="time"],
    input[type="number"],
    .calc-select {
      appearance: none;
      -webkit-appearance: none;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 15px;
      font-weight: 500;
      padding: 11px 14px;
      width: 100%;
      transition: border-color 0.2s;
    }
    input[type="time"]:focus,
    input[type="number"]:focus,
    .calc-select:focus { outline: none; border-color: rgba(59,130,246,0.5); }
    input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(0.5); }

    .calc-result {
      background: rgba(34,211,238,0.06);
      border: 1px solid rgba(34,211,238,0.20);
      border-radius: 16px;
      padding: 20px 24px;
      display: none;
    }
    .calc-result.visible { display: block; }
    .result-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--safe);
      margin-bottom: 6px;
    }
    .result-time {
      font-family: 'Courier New', monospace;
      font-size: 32px;
      font-weight: 700;
      color: var(--safe);
      margin-bottom: 10px;
    }
    .result-time.color-soon { color: var(--soon); border-color: rgba(251,191,36,0.20); }
    .result-time.color-urgent { color: var(--urgent); }
    .result-time.color-critical { color: var(--critical); }
    .result-breakdown {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .pill {
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px 10px;
    }
    .result-note {
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .result-note strong { color: var(--text); }
    .no-flight-msg {
      font-size: 14px;
      color: var(--muted);
      text-align: center;
      padding: 12px 0;
      display: none;
    }

    /* â”€â”€ Feature grid â”€â”€ */
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin: 0 0 72px;
    }
    .feature-card { padding: 28px; }
    .feature-icon { font-size: 28px; margin-bottom: 14px; display: block; }
    .feature-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
    .feature-desc { font-size: 14px; color: var(--muted); line-height: 1.6; }

    /* â”€â”€ Footer â”€â”€ */
    footer {
      border-top: 1px solid var(--border);
      padding: 28px 0;
      text-align: center;
    }
    footer p { font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="container">

    <!-- Nav -->
    <nav>
      <span class="wordmark">SwiftClear</span>
      <div class="nav-right">
        <span class="last-updated" id="lastUpdated"></span>
        <button class="refresh-btn" onclick="loadTerminals()">Refresh</button>
      </div>
    </nav>

    <!-- Hero -->
    <section class="hero">
      <div class="badge">
        <span class="badge-dot"></span>
        Live
      </div>
      <h1>Skip the guess.<br /><span>Know the wait.</span></h1>
      <p class="hero-sub">
        Real-time TSA wait times for every checkpoint â€” so you know exactly
        when to leave and never miss your flight.
      </p>
      <div class="cta-row">
        <a href="#calculator" class="btn btn-primary">
          Calculate Leave Time
        </a>
      </div>
    </section>

    <!-- Airport selector + live wait times -->
    <section class="live-section">
      <div class="section-header">
        <div class="airport-selector-wrap">
          <span class="airport-selector-label">Airport</span>
          <select id="airportSelect" onchange="onAirportChange()">
            <option value="ATL">Atlanta (ATL)</option>
            <option value="LAX">Los Angeles (LAX)</option>
            <option value="ORD">Chicago O'Hare (ORD)</option>
            <option value="DFW">Dallas Fort Worth (DFW)</option>
            <option value="DEN">Denver (DEN)</option>
            <option value="JFK">New York JFK (JFK)</option>
            <option value="SFO">San Francisco (SFO)</option>
            <option value="LAS">Las Vegas (LAS)</option>
            <option value="SEA">Seattle-Tacoma (SEA)</option>
            <option value="MCO">Orlando (MCO)</option>
            <option value="MIA">Miami (MIA)</option>
            <option value="BOS">Boston Logan (BOS)</option>
            <option value="PHX">Phoenix (PHX)</option>
            <option value="CLT">Charlotte (CLT)</option>
            <option value="MSP">Minneapolis (MSP)</option>
          </select>
        </div>
        <span class="live-dot" id="liveIndicator">Live</span>
      </div>

      <div class="terminals-grid" id="terminalsGrid">
        <!-- skeleton cards shown while loading -->
        <div class="glass terminal-card">
          <div class="terminal-card-top">
            <div class="skeleton skeleton-text"></div>
          </div>
          <div class="skeleton skeleton-number"></div>
          <div class="skeleton skeleton-text-sm"></div>
        </div>
        <div class="glass terminal-card">
          <div class="terminal-card-top">
            <div class="skeleton skeleton-text"></div>
          </div>
          <div class="skeleton skeleton-number"></div>
          <div class="skeleton skeleton-text-sm"></div>
        </div>
        <div class="glass terminal-card">
          <div class="terminal-card-top">
            <div class="skeleton skeleton-text"></div>
          </div>
          <div class="skeleton skeleton-number"></div>
          <div class="skeleton skeleton-text-sm"></div>
        </div>
      </div>
    </section>

    <!-- Leave-by calculator -->
    <section class="calculator-section" id="calculator">
      <div class="section-header">
        <span class="section-label">Leave-By Calculator</span>
      </div>
      <div class="glass calculator-card">
        <div class="calculator-title">When should I leave?</div>
        <p class="calculator-sub">
          Enter your flight time, pick your checkpoint, and we'll tell you
          exactly when to head to the airport.
        </p>

        <div class="calc-fields">
          <div class="field-group">
            <label class="field-label" for="flightTime">Flight Departure</label>
            <input type="time" id="flightTime" oninput="calculate()" />
          </div>
          <div class="field-group">
            <label class="field-label" for="driveTime">Drive to Airport (min)</label>
            <input type="number" id="driveTime" value="30" min="0" max="240" oninput="calculate()" />
          </div>
          <div class="field-group">
            <label class="field-label" for="checkpointSelect">Checkpoint</label>
            <select id="checkpointSelect" class="calc-select" onchange="calculate()">
              <option value="">Select a checkpointâ€¦</option>
            </select>
          </div>
        </div>

        <p class="no-flight-msg" id="noFlightMsg">Enter your flight departure time above to get your leave-by time.</p>

        <div class="calc-result" id="calcResult">
          <div class="result-label">Leave By</div>
          <div class="result-time" id="resultTime">â€”</div>
          <div class="result-breakdown" id="resultBreakdown"></div>
          <p class="result-note" id="resultNote"></p>
        </div>
      </div>
    </section>

    <!-- Features -->
    <div class="features">
      <div class="glass feature-card">
        <span class="feature-icon">âš¡</span>
        <div class="feature-title">Always Up to Date</div>
        <p class="feature-desc">
          Wait times are refreshed continuously from travelers currently
          inside the checkpoints, so you always have the latest picture
          before you leave.
        </p>
      </div>
      <div class="glass feature-card">
        <span class="feature-icon">ğŸ¯</span>
        <div class="feature-title">Leave at the Right Time</div>
        <p class="feature-desc">
          Tell us your departure time and we calculate exactly when you
          need to leave your house â€” no more guessing or padding with
          an extra hour "just in case."
        </p>
      </div>
      <div class="glass feature-card">
        <span class="feature-icon">âœˆï¸</span>
        <div class="feature-title">Every Major Airport</div>
        <p class="feature-desc">
          Coverage across major US airports with separate wait times for
          standard screening and TSA PreCheck lanes at every terminal.
        </p>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <p>Â© 2025 SwiftClear. All rights reserved.</p>
    </footer>

  </div>

  <script>
    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let allTerminals = [];    // { id, name, checkpoint_name, is_precheck }
    let waitTimes    = {};    // terminalId â†’ minutes (number | null)
    let refreshTimer = null;

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function colorClass(min) {
      if (min === null || min === undefined) return '';
      if (min < 15) return 'color-safe';
      if (min < 30) return 'color-soon';
      if (min < 45) return 'color-urgent';
      return 'color-critical';
    }

    function urgencyLabel(min) {
      if (min === null || min === undefined) return '';
      if (min < 15) return 'Short wait';
      if (min < 30) return 'Moderate wait';
      if (min < 45) return 'Long wait';
      return 'Very long wait';
    }

    function formatTime(date) {
      let h = date.getHours();
      const m = String(date.getMinutes()).padStart(2, '0');
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${m} ${ampm}`;
    }

    function minutesUntil(targetDate) {
      return Math.round((targetDate - Date.now()) / 60000);
    }

    // â”€â”€ Fetch terminals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTerminals() {
      const iata = document.getElementById('airportSelect').value;
      const grid = document.getElementById('terminalsGrid');
      const indicator = document.getElementById('liveIndicator');

      // Show skeletons
      grid.innerHTML = [1,2,3].map(() => `
        <div class="glass terminal-card">
          <div class="terminal-card-top">
            <div class="skeleton skeleton-text"></div>
          </div>
          <div class="skeleton skeleton-number" style="margin-top:12px;"></div>
          <div class="skeleton skeleton-text-sm"></div>
        </div>`).join('');

      allTerminals = [];
      waitTimes    = {};

      try {
        const res = await fetch(`/api/terminals?airportIata=${iata}`);
        if (!res.ok) throw new Error(`${res.status}`);
        allTerminals = await res.json();
      } catch (e) {
        grid.innerHTML = `<div class="error-state">Could not load checkpoints for ${iata}. Please try again.</div>`;
        return;
      }

      if (!allTerminals.length) {
        grid.innerHTML = `<div class="empty-state">No checkpoints found for ${iata}.</div>`;
        updateCheckpointDropdown();
        return;
      }

      // Render cards immediately with loading state, then fill in wait times
      renderTerminalCards(true);
      updateCheckpointDropdown();

      // Fetch all wait times in parallel
      await Promise.allSettled(
        allTerminals.map(t => fetchWaitTime(t.id))
      );

      renderTerminalCards(false);
      updateCalcResult();

      const now = new Date();
      document.getElementById('lastUpdated').textContent =
        `Updated ${formatTime(now)}`;
      indicator.textContent = 'Live';

      // Auto-refresh every 60 s
      clearInterval(refreshTimer);
      refreshTimer = setInterval(refreshWaitTimes, 60000);
    }

    // â”€â”€ Fetch a single wait time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchWaitTime(terminalId) {
      try {
        const res = await fetch(`/api/wait-times/${terminalId}`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        waitTimes[terminalId] = typeof data.estimatedWaitMinutes === 'number'
          ? data.estimatedWaitMinutes
          : null;
      } catch {
        waitTimes[terminalId] = null;
      }
    }

    // â”€â”€ Refresh wait times only (no terminal reload) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function refreshWaitTimes() {
      await Promise.allSettled(
        allTerminals.map(t => fetchWaitTime(t.id))
      );
      renderTerminalCards(false);
      updateCalcResult();
      const now = new Date();
      document.getElementById('lastUpdated').textContent =
        `Updated ${formatTime(now)}`;
    }

    // â”€â”€ Render terminal cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTerminalCards(loading) {
      const grid = document.getElementById('terminalsGrid');
      const selectedId = document.getElementById('checkpointSelect').value;

      grid.innerHTML = allTerminals.map(t => {
        const min = waitTimes[t.id];
        const cc  = colorClass(min);
        const isSelected = t.id === selectedId;

        const waitHtml = loading
          ? `<div class="skeleton skeleton-number"></div><div class="skeleton skeleton-text-sm" style="margin-top:6px;"></div>`
          : min === null
            ? `<div class="wait-number color-muted" style="font-family:monospace;font-size:28px;color:var(--muted)">â€”</div>
               <div class="wait-sublabel">No data</div>`
            : `<div class="wait-display">
                 <span class="wait-number ${cc}">${min}</span>
                 <span class="wait-unit ${cc}">min</span>
               </div>
               <div class="wait-sublabel">${urgencyLabel(min)}</div>`;

        const precheckBadge = t.is_precheck
          ? `<span class="precheck-tag">PREâœ“</span>`
          : '';

        return `
          <div class="glass terminal-card${isSelected ? ' selected' : ''}"
               onclick="selectCheckpoint('${t.id}')" data-id="${t.id}">
            <div class="terminal-card-top">
              <div class="terminal-name">${escHtml(t.name || t.checkpoint_name || 'Checkpoint')}</div>
              ${precheckBadge}
            </div>
            ${waitHtml}
          </div>`;
      }).join('');
    }

    function escHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // â”€â”€ Update checkpoint dropdown in calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateCheckpointDropdown() {
      const sel = document.getElementById('checkpointSelect');
      const cur = sel.value;
      sel.innerHTML = '<option value="">Select a checkpointâ€¦</option>' +
        allTerminals.map(t =>
          `<option value="${t.id}"${t.id === cur ? ' selected' : ''}>
            ${escHtml(t.name || t.checkpoint_name || 'Checkpoint')}${t.is_precheck ? ' (PreCheck)' : ''}
          </option>`
        ).join('');
      if (cur && allTerminals.find(t => t.id === cur)) sel.value = cur;
    }

    // â”€â”€ Clicking a card selects it in the calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function selectCheckpoint(id) {
      document.getElementById('checkpointSelect').value = id;
      // Scroll to calculator
      document.getElementById('calculator').scrollIntoView({ behavior: 'smooth', block: 'start' });
      renderTerminalCards(false);
      calculate();
    }

    // â”€â”€ Leave-by calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function calculate() {
      const flightTimeVal = document.getElementById('flightTime').value;
      const driveMin      = parseInt(document.getElementById('driveTime').value) || 30;
      const terminalId    = document.getElementById('checkpointSelect').value;

      const result    = document.getElementById('calcResult');
      const noFlight  = document.getElementById('noFlightMsg');

      if (!flightTimeVal) {
        result.classList.remove('visible');
        noFlight.style.display = 'block';
        return;
      }
      noFlight.style.display = 'none';

      // Parse departure time as today's date
      const now        = new Date();
      const [hh, mm]   = flightTimeVal.split(':').map(Number);
      const departure  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm);
      // If the departure time is in the past, assume tomorrow
      if (departure < now) departure.setDate(departure.getDate() + 1);

      const securityMin = (terminalId && waitTimes[terminalId] != null)
        ? waitTimes[terminalId]
        : 20; // default if no data yet

      const gateWalkMin = 10;
      const bufferMin   = 15;
      const totalBuffer = driveMin + securityMin + gateWalkMin + bufferMin;

      const leaveBy = new Date(departure.getTime() - totalBuffer * 60 * 1000);
      const minsUntilLeave = minutesUntil(leaveBy);

      // Color urgency of leave-by time
      let timeColor = 'color-safe';
      if (minsUntilLeave < 0)  timeColor = 'color-critical';
      else if (minsUntilLeave < 30) timeColor = 'color-urgent';
      else if (minsUntilLeave < 60) timeColor = 'color-soon';

      const resultTimeEl = document.getElementById('resultTime');
      resultTimeEl.textContent = formatTime(leaveBy);
      resultTimeEl.className = `result-time ${timeColor}`;

      document.getElementById('resultBreakdown').innerHTML = [
        `<span class="pill">Drive ${driveMin} min</span>`,
        `<span class="pill">Security ${securityMin} min</span>`,
        `<span class="pill">Gate walk ${gateWalkMin} min</span>`,
        `<span class="pill">Buffer ${bufferMin} min</span>`,
      ].join('');

      let noteText = '';
      if (minsUntilLeave < 0) {
        noteText = `<strong>You should have left ${Math.abs(minsUntilLeave)} min ago.</strong>`;
      } else if (minsUntilLeave < 30) {
        noteText = `<strong>Leave now</strong> â€” only ${minsUntilLeave} min until you need to go.`;
      } else {
        noteText = `<strong>${minsUntilLeave} minutes</strong> until you need to leave.`;
      }
      document.getElementById('resultNote').innerHTML = noteText;

      result.classList.add('visible');
    }

    function updateCalcResult() {
      const flightTimeVal = document.getElementById('flightTime').value;
      if (flightTimeVal) calculate();
    }

    // â”€â”€ Airport change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function onAirportChange() {
      clearInterval(refreshTimer);
      loadTerminals();
    }

    // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadTerminals();
  </script>
</body>
</html>
